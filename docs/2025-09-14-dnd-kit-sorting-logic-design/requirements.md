# 要求仕様書

## プロジェクト背景

本プロジェクトは、ネストした配列データを含むフォームにおいて、直感的なドラッグ&ドロップ操作による並び替え機能を実現することを目的としています。

## 対象データ構造

```typescript
type Data = {
    parentArray: Parent[];
};

type Parent = {
    parentKey: string;
    parentValue: string;
    childArray: Child[];
};

type Child = {
    childKey: string;
    childValue: string;
};
```

## 機能要件

### 基本並び替え機能

| 要件ID  | 機能                              | 説明                                          | 制約条件                   | 優先度 |
| ------- | --------------------------------- | --------------------------------------------- | -------------------------- | ------ |
| REQ-001 | Parent要素の並び替え              | parentArray内でParent要素の順序を変更可能     | 同一配列内のみ             | 高     |
| REQ-002 | Child要素の並び替え（同一親内）   | 同一Parent内でChild要素の順序を変更可能       | 同一親の子配列内のみ       | 高     |
| REQ-003 | Child要素の並び替え（異なる親間） | あるParentから別のParentにChild要素を移動可能 | 移動先はParent要素内に限定 | 高     |
| REQ-004 | 無効操作の防止                    | Child要素をParent要素の外に移動不可           | システム制約               | 高     |
| REQ-005 | 無効操作の防止                    | Parent要素をChild要素内に移動不可             | システム制約               | 高     |

### ドラッグ&ドロップ動作要件

| 要件ID  | 機能                   | 説明                                         | 受け入れ基準                     |
| ------- | ---------------------- | -------------------------------------------- | -------------------------------- |
| REQ-006 | ドラッグ要素の視覚化   | ドラッグ中の要素がマウスカーソルに追従       | ドラッグ中は元の位置から分離表示 |
| REQ-007 | プレースホルダー表示   | ドラッグ元の位置に空白プレースホルダーを表示 | 元要素と同じサイズの空白領域     |
| REQ-008 | ドロップインジケーター | ドロップ可能位置にインジケーターを表示       | 挿入位置を明確に示すビジュアル   |
| REQ-009 | リアルタイム更新制御   | ドラッグ中は要素の位置変更を行わない         | ドロップ時のみデータ更新実行     |
| REQ-010 | 範囲外ドラッグ許可     | 要素の移動範囲に制限を設けない               | 異なる親への移動を可能にする     |

### デュアルインターフェース要件

| 要件ID  | 機能             | 説明                                                    | 同期仕様                      |
| ------- | ---------------- | ------------------------------------------------------- | ----------------------------- |
| REQ-011 | フォーム側操作   | 入力フィールドを含む完全なフォームでのドラッグ&ドロップ | 即座にサイドバーに反映        |
| REQ-012 | サイドバー側操作 | インデックス情報のみのリストでのドラッグ&ドロップ       | 即座にフォームに反映          |
| REQ-013 | 双方向同期       | 片方での変更がもう片方に即座に反映                      | リアルタイム同期必須          |
| REQ-014 | データ整合性     | 両インターフェースで同一のデータ状態を維持              | 同期遅延の許容範囲: 100ms以内 |

## 非機能要件

### パフォーマンス要件

| 要件ID   | 項目           | 基準値       | 測定条件              |
| -------- | -------------- | ------------ | --------------------- |
| PERF-001 | ドラッグ応答性 | 16ms以内     | 60FPS維持             |
| PERF-002 | データ同期遅延 | 100ms以内    | フォーム⇔サイドバー間 |
| PERF-003 | 大量データ処理 | 1000要素まで | スムーズな操作を維持  |

### ユーザビリティ要件

| 要件ID | 項目                 | 説明                                       |
| ------ | -------------------- | ------------------------------------------ |
| UX-001 | 視覚的フィードバック | ドラッグ状態、ドロップ可能位置の明確な表示 |
| UX-002 | エラー防止           | 無効な操作の視覚的な阻止表示               |
| UX-003 | 操作の取り消し       | ドラッグ操作のキャンセル機能               |

### ブラウザ互換性要件

| 要件ID     | ブラウザ | バージョン |
| ---------- | -------- | ---------- |
| COMPAT-001 | Chrome   | 90+        |
| COMPAT-002 | Firefox  | 88+        |
| COMPAT-003 | Safari   | 14+        |
| COMPAT-004 | Edge     | 90+        |

## 制約条件

### 技術制約

- React Hook Form を使用したフォーム状態管理必須
- @dnd-kit ライブラリの使用必須
- TypeScript による型安全性の確保

### ビジネス制約

- 既存のフォーム構造への影響を最小限に抑制
- 段階的なリリースによる影響範囲の制御

## 受け入れテスト項目

### 基本機能テスト

1. **Parent要素の並び替え**
    - フォーム内でのParent要素ドラッグ&ドロップ: 完了
    - サイドバー内でのParent要素ドラッグ&ドロップ: 完了
    - 双方向同期の確認: 完了

2. **Child要素の並び替え（同一親内）**
    - フォーム内での同一Parent内でのChild要素移動: 完了
    - サイドバー内での同一Parent内でのChild要素移動
    - 双方向同期の確認

3. **Child要素の並び替え（異なる親間）**
    - 異なるParent間でのChild要素移動
    - 移動後のデータ整合性確認

### エラーケーステスト

1. **無効操作の防止**
    - Child要素をParent要素外への移動試行
    - Parent要素をChild要素内への移動試行
    - 適切なエラーハンドリングの確認

2. **境界値テスト**
    - 空の配列での操作
    - 単一要素での操作
    - 大量データでの操作

### パフォーマンステスト

1. **応答性テスト**
    - ドラッグ操作のフレームレート測定
    - データ同期の遅延測定

2. **負荷テスト**
    - 大量データでの安定性確認
    - メモリ使用量の監視

## 用語集

| 用語                     | 定義                                    |
| ------------------------ | --------------------------------------- |
| Parent要素               | データ構造の最上位レベルの要素          |
| Child要素                | Parent要素に含まれる子レベルの要素      |
| デュアルインターフェース | フォーム側とサイドバー側の2つの操作界面 |
| ドロップインジケーター   | ドロップ可能位置を示す視覚的要素        |
| プレースホルダー         | ドラッグ元の位置を示す空白領域          |
